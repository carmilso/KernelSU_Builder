name: KernelSU Next Builder - OnePlus 8T

on:
  push:
  workflow_dispatch:
  repository_dispatch:
    types: [trigger-KernelSU-build]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["LineageOS-23-kebab", "LineageOS-23.2-kebab"]

    env:
      VERSION: ${{ matrix.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3-pip python-is-python3 jq wget libarchive-tools device-tree-compiler binutils-aarch64-linux-gnu
          version: 1.0

      - name: Install Python dependencies
        run: sudo pip3 install pyyaml

      - name: Restore Clang toolchain from cache
        id: clang-cache
        uses: actions/cache@v4
        with:
          path: clang-cache
          key: clang-r547379

      - name: Clone clang and kernel sources
        run: |
          chmod +x clone.sh
          ./clone.sh

      - name: Restore cached Clang into kernel tree
        if: steps.clang-cache.outputs.cache-hit == 'true'
        run: |
          rm -rf kernel/clang
          mv clang-cache kernel/clang

      - name: Save Clang to cache directory
        if: steps.clang-cache.outputs.cache-hit != 'true'
        run: cp -a kernel/clang clang-cache

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.version }}-ccache
          max-size: 2G

      - name: Add Clang to PATH
        run: |
          echo "${{ github.workspace }}/kernel/clang/bin" >> $GITHUB_PATH
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      - name: Configure ccache
        run: |
          ccache -M 2G
          ccache -z
          ccache -s

      - name: Verify Clang toolchain
        run: |
          which clang || { echo "ERROR: clang not found in PATH!"; exit 1; }
          echo "Using clang:"
          clang --version | head -1

      - name: Compile kernel
        env:
          KBUILD_BUILD_HOST: Github-Action
          KBUILD_BUILD_USER: KernelSU_Builder
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Make output directory for kernel
        run: |
          mkdir -p outw/false outw/true

      - name: Move kernel without KernelSU support to output directory
        run: |
          chmod +x move.sh
          ./move.sh

      - name: Clean build environment
        run: |
          chmod +x clean.sh
          ./clean.sh

      - name: Set KERNELSU environment variable to true
        run: echo "KERNELSU=true" >> $GITHUB_ENV

      - name: Set KERNELSU_VERSION environment variable
        run: echo "KERNELSU_VERSION=$(cat ksu_version.txt)" >> $GITHUB_ENV

      - name: Add KernelSU Next support to kernel
        run: |
          chmod +x kernelSU.sh
          ./kernelSU.sh

      - name: Compile kernel with KernelSU Next support
        env:
          KBUILD_BUILD_HOST: Github-Action
          KBUILD_BUILD_USER: KernelSU_Builder
        run: |
          set -e  # Exit on any error
          cd kernel
          
          # Read config and build commands from sources.yaml
          json=$(python -c "import sys, yaml, json; json.dump(yaml.safe_load(sys.stdin), sys.stdout)" < ../sources.yaml)
          config_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].config[]')
          build_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].build[]')

          # Step 1: Generate .config using merge_config.sh and resolve dependencies
          echo "=== Generating kernel config ==="
          eval "$config_cmd"

          # Step 2: Inject KernelSU kprobes hook config using scripts/config
          echo "=== Configuring KernelSU ==="
          scripts/config --file out/.config --enable KSU || { echo "ERROR: Failed to enable KSU"; exit 1; }
          scripts/config --file out/.config --disable KSU_MANUAL_HOOK || { echo "ERROR: Failed to disable KSU_MANUAL_HOOK"; exit 1; }
          scripts/config --file out/.config --enable KSU_KPROBES_HOOK || { echo "ERROR: Failed to enable KSU_KPROBES_HOOK"; exit 1; }

          # Step 3: Resolve all config dependencies with full toolchain flags
          echo "=== Resolving config dependencies ==="
          make O=out ARCH=arm64 LLVM=1 CROSS_COMPILE=aarch64-linux-gnu- CLANG_TRIPLE=aarch64-linux-gnu- olddefconfig

          # Step 4: Verify KSU config was properly applied
          echo "=== Verifying KernelSU configuration ==="
          if ! grep -q "CONFIG_KSU=y" out/.config; then
              echo "ERROR: CONFIG_KSU not enabled in .config!"
              exit 1
          fi
          if ! grep -q "CONFIG_KSU_KPROBES_HOOK=y" out/.config; then
              echo "ERROR: CONFIG_KSU_KPROBES_HOOK not enabled in .config!"
              exit 1
          fi
          echo "KernelSU configuration verified successfully"

          # Step 5: Build
          echo "=== Building kernel ==="
          eval "$build_cmd"
          
          # Step 6: Show ccache stats
          echo "=== ccache statistics ==="
          ccache -s

      - name: Move kernel with KernelSU Next support to output directory
        run: |
          chmod +x move.sh
          ./move.sh

      - name: Show kernel build info
        if: success()
        run: |
          echo "=== Kernel build completed successfully ==="
          if [ -f kernel/out/arch/arm64/boot/Image ]; then
            echo "Kernel Image:"
            ls -lh kernel/out/arch/arm64/boot/Image
            echo "Size: $(du -h kernel/out/arch/arm64/boot/Image | cut -f1)"
          fi
          if [ -f kernel/out/arch/arm64/boot/Image.gz ]; then
            echo "Kernel Image.gz:"
            ls -lh kernel/out/arch/arm64/boot/Image.gz
            echo "Size: $(du -h kernel/out/arch/arm64/boot/Image.gz | cut -f1)"
          fi
          echo "=== Final ccache statistics ==="
          ccache -s

      - name: Clone AnyKernel3
        run: |
          chmod +x anykernel.sh
          ./anykernel.sh

      - name: Configure AnyKernel3 for OnePlus 8T
        run: |
          cp anykernel_config.sh AnyKernel3/anykernel.sh

      - name: Set ZIP_NO_KSU and ZIP_KSU environment variables
        run: |
          echo "ZIP_NO_KSU=${{ env.VERSION }}-NoKernelSU.zip" >> $GITHUB_ENV
          echo "ZIP_KSU=${{ env.VERSION }}-KernelSU-Next-$(cat ksu_version.txt).zip" >> $GITHUB_ENV

      - name: Make AnyKernel3 zip
        run: |
          chmod +x makezip.sh
          ./makezip.sh

      - name: Extract info for release
        run: |
          chmod +x extract.sh
          ./extract.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-${{ matrix.version }}-build-info
          path: |
            kernel/out/.config
            kernel/out/include/config/auto.conf
          retention-days: 7

      - name: Make a release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/${{ env.ZIP_NO_KSU }}
            ${{ github.workspace }}/${{ env.ZIP_KSU }}
          token: ${{ secrets.GITHUB_TOKEN }}
          name: KernelSU Next ${{ env.KERNELSU_VERSION }} - ${{ matrix.version }}
          tag_name: v${{ env.KERNELSU_VERSION }}-${{ github.run_number }}
          body: |
            **Info:**
            - KernelSU Next Version: ${{ env.KERNELSU_VERSION }} (legacy branch)
            - Device: OnePlus 8T (kebab)
            - Kernel: 4.19 (SM8250/kona)
            - Hook method: kprobes

            **Variants:**
            - `LineageOS-23-kebab` — LineageOS 23.0 (lineage-23.0 branch)
            - `LineageOS-23.2-kebab` — LineageOS 23.2 (lineage-23.2 branch)

            **Installation:**
            - Download the zip matching your ROM version.
            - Flash in recovery using sideload or any other method.

            <details>
              <summary>Build Settings</summary>
              ```
              ${{ env.buildsettings }}
              ```
            </details>
          draft: false
          prerelease: false
