name: KernelSU Next Builder - OnePlus 8T

on:
  push:
  workflow_dispatch:
    inputs:
      build_without_ksu:
        description: 'Build kernel without KernelSU (for debugging/testing)'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types: [trigger-KernelSU-build]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["LineageOS-23-kebab", "LineageOS-23.2-kebab"]

    env:
      VERSION: ${{ matrix.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show build configuration
        run: |
          echo "=========================================="
          echo "  Build Configuration"
          echo "=========================================="
          echo "Version: ${{ matrix.version }}"
          echo "Build without KernelSU: ${{ inputs.build_without_ksu || 'false' }}"
          echo "=========================================="

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3-pip python-is-python3 jq wget libarchive-tools device-tree-compiler binutils-aarch64-linux-gnu
          version: 1.0

      - name: Install Python dependencies
        run: sudo pip3 install pyyaml

      - name: Restore Clang toolchain from cache
        id: clang-cache
        uses: actions/cache@v4
        with:
          path: clang-cache
          key: clang-r547379

      - name: Clone clang and kernel sources
        run: |
          chmod +x clone.sh
          ./clone.sh

      - name: Restore cached Clang into kernel tree
        if: steps.clang-cache.outputs.cache-hit == 'true'
        run: |
          rm -rf kernel/clang
          mv clang-cache kernel/clang

      - name: Save Clang to cache directory
        if: steps.clang-cache.outputs.cache-hit != 'true'
        run: cp -a kernel/clang clang-cache

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.version }}-ccache
          max-size: 2G

      - name: Add Clang to PATH
        run: |
          echo "${{ github.workspace }}/kernel/clang/bin" >> $GITHUB_PATH
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      - name: Configure ccache
        run: |
          ccache -M 2G
          ccache -z
          ccache -s

      - name: Verify Clang toolchain
        run: |
          which clang || { echo "ERROR: clang not found in PATH!"; exit 1; }
          echo "Using clang:"
          clang --version | head -1

      - name: Compile kernel without KernelSU (optional)
        if: inputs.build_without_ksu == true
        env:
          KBUILD_BUILD_HOST: Github-Action
          KBUILD_BUILD_USER: KernelSU_Builder
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Make output directory for kernel
        run: |
          mkdir -p outw/false outw/true

      - name: Move kernel without KernelSU support to output directory
        if: inputs.build_without_ksu == true
        run: |
          chmod +x move.sh
          ./move.sh

      - name: Clean build environment
        if: inputs.build_without_ksu == true
        run: |
          chmod +x clean.sh
          ./clean.sh

      - name: Set KERNELSU environment variable to true
        run: echo "KERNELSU=true" >> $GITHUB_ENV

      - name: Check if SUSFS is enabled for this version
        id: check-susfs
        run: |
          json=$(python -c "import sys, yaml, json; json.dump(yaml.safe_load(sys.stdin), sys.stdout)" < sources.yaml)
          susfs_enabled=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].susfs.enabled // false')
          echo "susfs_enabled=$susfs_enabled" >> $GITHUB_OUTPUT
          echo "SUSFS enabled for $VERSION: $susfs_enabled"

      - name: Check for new SUSFS patch version
        if: steps.check-susfs.outputs.susfs_enabled == 'true'
        id: check-susfs-version
        run: |
          chmod +x scripts/check-susfs-version.sh
          ./scripts/check-susfs-version.sh || true

      - name: Add KernelSU-Next-SUSFS support to kernel
        if: steps.check-susfs.outputs.susfs_enabled == 'true'
        env:
          KSU_REPO_URL: https://github.com/wshamroukh/KernelSU-Next-SUSFS-kernelv4.19
          KSU_BRANCH: legacy
        run: |
          chmod +x scripts/kernelSU-susfs.sh
          ./scripts/kernelSU-susfs.sh

      - name: Add KernelSU Next support to kernel (standard)
        if: steps.check-susfs.outputs.susfs_enabled != 'true'
        run: |
          chmod +x kernelSU.sh
          ./kernelSU.sh

      - name: Extract KernelSU version
        run: |
          chmod +x scripts/get-ksu-version.sh
          ./scripts/get-ksu-version.sh
          
      - name: Set KERNELSU_VERSION environment variable
        run: echo "KERNELSU_VERSION=$(cat ksu_version.txt)" >> $GITHUB_ENV

      - name: Apply SUSFS patches and hooks
        if: steps.check-susfs.outputs.susfs_enabled == 'true'
        run: |
          chmod +x scripts/apply-susfs.sh
          ./scripts/apply-susfs.sh

      - name: Compile kernel with KernelSU Next support (SUSFS)
        if: steps.check-susfs.outputs.susfs_enabled == 'true'
        env:
          KBUILD_BUILD_HOST: Github-Action
          KBUILD_BUILD_USER: KernelSU_Builder
        run: |
          set -e  # Exit on any error
          cd kernel
          
          # Read config and build commands from sources.yaml
          json=$(python -c "import sys, yaml, json; json.dump(yaml.safe_load(sys.stdin), sys.stdout)" < ../sources.yaml)
          config_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].config[]')
          build_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].build[]')

          # Step 1: Generate .config using merge_config.sh and resolve dependencies
          echo "=== Generating kernel config ==="
          eval "$config_cmd"

          # Step 2: Apply SUSFS config options using configure-susfs.sh
          echo "=== Configuring KernelSU + SUSFS ==="
          chmod +x ../scripts/configure-susfs.sh
          ../scripts/configure-susfs.sh

          # Step 3: Build
          echo "=== Building kernel with KernelSU + SUSFS ==="
          eval "$build_cmd"
          
          # Step 5: Show ccache stats
          echo "=== ccache statistics ==="
          ccache -s

      - name: Compile kernel with KernelSU Next support (standard)
        if: steps.check-susfs.outputs.susfs_enabled != 'true'
        env:
          KBUILD_BUILD_HOST: Github-Action
          KBUILD_BUILD_USER: KernelSU_Builder
        run: |
          set -e  # Exit on any error
          cd kernel
          
          # Read config and build commands from sources.yaml
          json=$(python -c "import sys, yaml, json; json.dump(yaml.safe_load(sys.stdin), sys.stdout)" < ../sources.yaml)
          config_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].config[]')
          build_cmd=$(echo "$json" | jq -r --arg v "$VERSION" '.[$v].build[]')

          # Step 1: Generate .config using merge_config.sh and resolve dependencies
          echo "=== Generating kernel config ==="
          eval "$config_cmd"

          # Step 2: Inject KernelSU kprobes hook config using scripts/config
          echo "=== Configuring KernelSU ==="
          scripts/config --file out/.config --enable KSU || { echo "ERROR: Failed to enable KSU"; exit 1; }
          scripts/config --file out/.config --disable KSU_MANUAL_HOOK || { echo "ERROR: Failed to disable KSU_MANUAL_HOOK"; exit 1; }
          scripts/config --file out/.config --enable KSU_KPROBES_HOOK || { echo "ERROR: Failed to enable KSU_KPROBES_HOOK"; exit 1; }

          # Step 3: Resolve all config dependencies with full toolchain flags
          echo "=== Resolving config dependencies ==="
          make O=out ARCH=arm64 LLVM=1 CROSS_COMPILE=aarch64-linux-gnu- CLANG_TRIPLE=aarch64-linux-gnu- olddefconfig

          # Step 4: Verify KSU config was properly applied
          echo "=== Verifying KernelSU configuration ==="
          if ! grep -q "CONFIG_KSU=y" out/.config; then
              echo "ERROR: CONFIG_KSU not enabled in .config!"
              exit 1
          fi
          if ! grep -q "CONFIG_KSU_KPROBES_HOOK=y" out/.config; then
              echo "ERROR: CONFIG_KSU_KPROBES_HOOK not enabled in .config!"
              exit 1
          fi
          echo "KernelSU configuration verified successfully"

          # Step 5: Build
          echo "=== Building kernel ==="
          eval "$build_cmd"
          
          # Step 6: Show ccache stats
          echo "=== ccache statistics ==="
          ccache -s

      - name: Move kernel with KernelSU Next support to output directory
        run: |
          chmod +x move.sh
          ./move.sh

      - name: Show kernel build info
        if: success()
        run: |
          echo "=== Kernel build completed successfully ==="
          if [ -f kernel/out/arch/arm64/boot/Image ]; then
            echo "Kernel Image:"
            ls -lh kernel/out/arch/arm64/boot/Image
            echo "Size: $(du -h kernel/out/arch/arm64/boot/Image | cut -f1)"
          fi
          if [ -f kernel/out/arch/arm64/boot/Image.gz ]; then
            echo "Kernel Image.gz:"
            ls -lh kernel/out/arch/arm64/boot/Image.gz
            echo "Size: $(du -h kernel/out/arch/arm64/boot/Image.gz | cut -f1)"
          fi
          echo "=== Final ccache statistics ==="
          ccache -s

      - name: Clone AnyKernel3
        run: |
          chmod +x anykernel.sh
          ./anykernel.sh

      - name: Configure AnyKernel3 for OnePlus 8T
        run: |
          cp anykernel_config.sh AnyKernel3/anykernel.sh

      - name: Set ZIP_NO_KSU and ZIP_KSU environment variables
        run: |
          echo "ZIP_NO_KSU=${{ env.VERSION }}-NoKernelSU.zip" >> $GITHUB_ENV
          echo "ZIP_KSU=${{ env.VERSION }}-KernelSU-Next-${{ env.KERNELSU_VERSION }}.zip" >> $GITHUB_ENV

      - name: Make AnyKernel3 zip
        run: |
          chmod +x makezip.sh
          ./makezip.sh

      - name: Extract info for release
        run: |
          chmod +x extract.sh
          ./extract.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kernel-${{ matrix.version }}-build-info
          path: |
            kernel/out/.config
            kernel/out/include/config/auto.conf
          retention-days: 7

      - name: Prepare release notes
        id: release-notes
        run: |
          if [ "${{ steps.check-susfs.outputs.susfs_enabled }}" = "true" ]; then
            cat > release_body.md << 'EOF'
            **Info:**
            - KernelSU Next Version: ${{ env.KERNELSU_VERSION }} (wshamroukh SUSFS variant)
            - SUSFS Version: v2.0.0
            - Device: OnePlus 8T (kebab)
            - Kernel: 4.19 (SM8250/kona)
            - Hook method: manual hooks (non-GKI)
            
            **Features:**
            - ✅ KernelSU-Next with SUSFS integration
            - ✅ SUSFS v2.0.0 (Systemless UID and FileSystem spoofing)
            - ✅ Path hiding (SUS_PATH)
            - ✅ Mount hiding (SUS_MOUNT)
            - ✅ Kstat spoofing (SUS_KSTAT)
            - ✅ Try umount support (TRY_UMOUNT)
            - ✅ Uname spoofing
            - ✅ Symbol hiding
            - ✅ Cmdline/bootconfig spoofing
            - ✅ Open redirect
            - ✅ Map hiding (SUS_MAP)

            **Variants:**
            - `LineageOS-23-kebab` — LineageOS 23.0 (standard KernelSU, kprobes)
            - `LineageOS-23.2-kebab` — LineageOS 23.2 (KernelSU + SUSFS, manual hooks) ⭐

            **Installation:**
            - Download the zip matching your ROM version.
            - Flash in recovery using sideload or any other method.
            - **Note:** LineageOS 23.2 variant includes SUSFS features for enhanced root hiding.
            
            **SUSFS Configuration:**
            - Configure SUSFS via KernelSU Manager app or ksud CLI
            - See [SUSFS documentation](https://github.com/sidex15/SUSFS4KSU) for usage guide
            
            **Available Downloads:**
            - KernelSU-enabled kernel (recommended)
          EOF
          
          if [ -f "${{ github.workspace }}/${{ env.ZIP_NO_KSU }}" ]; then
            echo "            - Vanilla kernel without KernelSU (optional, for debugging)" >> release_body.md
          fi
          else
            cat > release_body.md << 'EOF'
            **Info:**
            - KernelSU Next Version: ${{ env.KERNELSU_VERSION }} (legacy branch)
            - Device: OnePlus 8T (kebab)
            - Kernel: 4.19 (SM8250/kona)
            - Hook method: kprobes

            **Variants:**
            - `LineageOS-23-kebab` — LineageOS 23.0 (lineage-23.0 branch)
            - `LineageOS-23.2-kebab` — LineageOS 23.2 (lineage-23.2 branch)

            **Installation:**
            - Download the zip matching your ROM version.
            - Flash in recovery using sideload or any other method.
            
            **Available Downloads:**
            - KernelSU-enabled kernel (recommended)
          EOF
          
          if [ -f "${{ github.workspace }}/${{ env.ZIP_NO_KSU }}" ]; then
            echo "            - Vanilla kernel without KernelSU (optional, for debugging)" >> release_body.md
          fi
          fi
          
          # Add SUSFS version check warning if new version detected
          if [ "${{ steps.check-susfs-version.outputs.NEW_SUSFS_VERSION }}" = "true" ]; then
            echo "" >> release_body.md
            echo "---" >> release_body.md
            echo "" >> release_body.md
            echo "⚠️ **Note:** A newer SUSFS patch version may be available. Check the [SUSFS repository](${{ steps.check-susfs-version.outputs.SUSFS_UPSTREAM_URL }}) for updates." >> release_body.md
          fi
          
          # Add build settings
          cat >> release_body.md << 'EOF'
          
          <details>
            <summary>Build Settings</summary>
            
            ```
            ${{ env.buildsettings }}
            ```
          </details>
          EOF

      - name: Prepare release files list
        id: release-files
        run: |
          FILES="${{ github.workspace }}/${{ env.ZIP_KSU }}"
          if [ -f "${{ github.workspace }}/${{ env.ZIP_NO_KSU }}" ]; then
            FILES="${FILES}"$'\n'"${{ github.workspace }}/${{ env.ZIP_NO_KSU }}"
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Make a release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.release-files.outputs.files }}
          token: ${{ secrets.GITHUB_TOKEN }}
          name: KernelSU Next ${{ env.KERNELSU_VERSION }} - ${{ matrix.version }}
          tag_name: v${{ env.KERNELSU_VERSION }}-${{ github.run_number }}
          body_path: release_body.md
          draft: false
          prerelease: false
